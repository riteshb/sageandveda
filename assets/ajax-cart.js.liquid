/*============================================================================
  Ajax the add to cart experience by revealing it in a side drawer
  Plugin Documentation - http://shopify.github.io/Timber/#ajax-cart
  (c) Copyright 2015 Shopify Inc. Author: Carson Shold (@cshold). All Rights Reserved.

  This file includes:
    - Basic Shopify Ajax API calls
    - Ajax cart plugin

  This requires:
    - jQuery 1.8+
    - handlebars.min.js (for cart template)
    - modernizer.min.js
    - snippet/ajax-cart-template.liquid

  Customized version of Shopify's jQuery API
  (c) Copyright 2009-2015 Shopify Inc. Author: Caroline Schnapp. All Rights Reserved.
==============================================================================*/
if ((typeof ShopifyAPI) === 'undefined') { ShopifyAPI = {}; }

/*============================================================================
  API Helper Functions
==============================================================================*/
function attributeToString(attribute) {
  if ((typeof attribute) !== 'string') {
    attribute += '';
    if (attribute === 'undefined') {
      attribute = '';
    }
  }
  return jQuery.trim(attribute);
};

/*============================================================================
  API Functions
==============================================================================*/
ShopifyAPI.onCartUpdate = function(cart) {
  // alert('There are now ' + cart.item_count + ' items in the cart.');
};

ShopifyAPI.updateCartNote = function(note, callback) {
  var params = {
    type: 'POST',
    url: '/cart/update.js',
    data: 'note=' + attributeToString(note),
    dataType: 'json',
    success: function(cart) {
      if ((typeof callback) === 'function') {
        callback(cart);
      }
      else {
        ShopifyAPI.onCartUpdate(cart);
      }
    },
    error: function(XMLHttpRequest, textStatus) {
      ShopifyAPI.onError(XMLHttpRequest, textStatus);
    }
  };
  jQuery.ajax(params);
};

ShopifyAPI.onError = function(XMLHttpRequest, textStatus) {
  var data = eval('(' + XMLHttpRequest.responseText + ')');
  if (!!data.message) {
    alert(data.message + '(' + data.status  + '): ' + data.description);
  }
};

/*============================================================================
  POST to cart/add.js returns the JSON of the cart
    - Allow use of form element instead of just id
    - Allow custom error callback
==============================================================================*/
ShopifyAPI.addItemFromForm = function(form, callback, errorCallback) {
  var params = {
    type: 'POST',
    url: '/cart/add.js',
    data: jQuery(form).serialize(),
    dataType: 'json',
    success: function(line_item) {
      if ((typeof callback) === 'function') {
        callback(line_item, form);
      }
      else {
        ShopifyAPI.onItemAdded(line_item, form);
      }
    },
    error: function(XMLHttpRequest, textStatus) {
      if ((typeof errorCallback) === 'function') {
        errorCallback(XMLHttpRequest, textStatus);
      }
      else {
        ShopifyAPI.onError(XMLHttpRequest, textStatus);
      }
    }
  };
  jQuery.ajax(params);
};

// Get from cart.js returns the cart in JSON
ShopifyAPI.getCart = function(callback) {
  jQuery.getJSON('/cart.js', function (cart, textStatus) {
    if ((typeof callback) === 'function') {
      callback(cart);
    }
    else {
      ShopifyAPI.onCartUpdate(cart);
    }
  });
};

// POST to cart/change.js returns the cart in JSON
ShopifyAPI.changeItem = function(line, quantity, callback, variantId) {
  // Ensure line is a valid number (1-based index)
  var parsedLine = parseInt(line, 10);
  quantity = parseInt(quantity, 10);
  
  var dataString;
  
  // Use line parameter if valid, otherwise fall back to variant ID
  if (!isNaN(parsedLine) && parsedLine >= 1) {
    dataString = 'quantity=' + quantity + '&line=' + parsedLine;
  } else if (variantId) {
    // Fallback to variant ID if line is invalid
    dataString = 'quantity=' + quantity + '&id=' + variantId;
  } else {
    console.error('Invalid line number and no variant ID provided:', line);
    return;
  }
  
  var params = {
    type: 'POST',
    url: '/cart/change.js',
    data: dataString,
    dataType: 'json',
    success: function(cart) {
      if ((typeof callback) === 'function') {
        callback(cart);
      }
      else {
        ShopifyAPI.onCartUpdate(cart);
      }
    },
    error: function(XMLHttpRequest, textStatus) {
      ShopifyAPI.onError(XMLHttpRequest, textStatus);
    }
  };
  jQuery.ajax(params);
};

/*============================================================================
  Ajax Shopify Add To Cart
==============================================================================*/
var ajaxCart = (function(module, $) {

  'use strict';

  // Public functions
  var init, loadCart;

  // Private general variables
  var settings, isUpdating, $body;

  // Private plugin variables
  var $formContainer, $addToCart, $cartCountSelector, $cartCostSelector, $cartContainer, $drawerContainer;

  // Private functions
  var updateCountPrice, formOverride, itemAddedCallback, itemErrorCallback, cartUpdateCallback, buildCart, cartCallback, adjustCart, adjustCartCallback, createQtySelectors, qtySelectors, validateQty;

  /*============================================================================
    Initialise the plugin and define global options
  ==============================================================================*/
  init = function (options) {

    // Default settings
    settings = {
      formSelector       : 'form[action^="/cart/add"]',
      cartContainer      : '#CartContainer',
      addToCartSelector  : 'input[type="submit"]',
      cartCountSelector  : 'CartCount',
      cartCostSelector   : null,
      moneyFormat        : '${{amount}}',
      disableAjaxCart    : false,
      enableQtySelectors : true
    };

    // Override defaults with arguments
    $.extend(settings, options);

    // Select DOM elements
    $formContainer     = $(settings.formSelector);
    $cartContainer     = $(settings.cartContainer);
    $addToCart         = $formContainer.find(settings.addToCartSelector);
    $cartCountSelector = $(settings.cartCountSelector);
    $cartCostSelector  = $(settings.cartCostSelector);

    // General Selectors
    $body = $('body');

    // Track cart activity status
    isUpdating = false;

    // Setup ajax quantity selectors on the any template if enableQtySelectors is true
    if (settings.enableQtySelectors) {
      qtySelectors();
    }

    // Take over the add to cart form submit action if ajax enabled
    if (!settings.disableAjaxCart && $addToCart.length) {
      formOverride();
    }

    // Run this function in case we're using the quantity selector outside of the cart
    adjustCart();
  };

  loadCart = function () {
    $body.addClass('drawer--is-loading');
    ShopifyAPI.getCart(cartUpdateCallback);
  };

  updateCountPrice = function (cart) {
    if ($cartCountSelector) {
      $cartCountSelector.html(cart.item_count).removeClass('hidden-count');

      if (cart.item_count === 0) {
        $cartCountSelector.addClass('hidden-count');
      }
    }
    if ($cartCostSelector) {
      $cartCostSelector.html(Shopify.formatMoney(cart.total_price, settings.moneyFormat));
    }
  };

  formOverride = function () {
    // Remove any existing handlers to prevent duplicates
    $formContainer.off('submit.ajaxcart');
    
    $formContainer.on('submit.ajaxcart', function(evt) {
      // Prevent multiple submissions
      if (isUpdating) {
        evt.preventDefault();
        evt.stopImmediatePropagation();
        return false;
      }
      
      evt.preventDefault();
      evt.stopImmediatePropagation();

      var $form = $(evt.target);
      
      // Get the ProductSelect dropdown - try multiple selectors
      var productSelect = $form.find('select[id^="ProductSelect-"]');
      if (!productSelect.length) {
        // Try finding it by name attribute
        productSelect = $form.find('select[name="id"]');
      }
      
      var variantId = null;
      
      // Try multiple ways to get the variant ID
      // 1. Check for hidden input with name="id"
      var idInput = $form.find('input[name="id"]');
      if (idInput.length && idInput.val()) {
        variantId = idInput.val();
      }
      
      // 2. Check ProductSelect value
      if ((!variantId || variantId === '0' || variantId === '') && productSelect.length) {
        variantId = productSelect.val();
      }
      
      // 3. Check select[name="id"] directly
      if ((!variantId || variantId === '0' || variantId === '') && productSelect.length) {
        var selectById = $form.find('select[name="id"]');
        if (selectById.length && selectById.val()) {
          variantId = selectById.val();
        }
      }
      
      // 4. For single-variant products, get the first available option
      if ((!variantId || variantId === '0' || variantId === '') && productSelect.length) {
        // Try to find any option with a value
        var firstOption = productSelect.find('option[value]:not([value=""]):not([value="0"])').first();
        if (!firstOption.length) {
          // Try without filtering disabled
          firstOption = productSelect.find('option[value]').not('[value=""]').not('[value="0"]').first();
        }
        if (firstOption.length) {
          variantId = firstOption.attr('value') || firstOption.val();
          if (variantId && variantId !== '0' && variantId !== '') {
            productSelect.val(variantId);
          }
        }
      }
      
      // 5. Last resort: check if ProductSelect has any selected option
      if ((!variantId || variantId === '0' || variantId === '') && productSelect.length) {
        var selectedOption = productSelect.find('option:selected');
        if (selectedOption.length) {
          var selectedVal = selectedOption.attr('value') || selectedOption.val();
          if (selectedVal && selectedVal !== '0' && selectedVal !== '') {
            variantId = selectedVal;
          }
        }
        // If still no value, try finding option with selected attribute
        if ((!variantId || variantId === '0' || variantId === '') && productSelect.length) {
          var selectedByAttr = productSelect.find('option[selected="selected"]');
          if (!selectedByAttr.length) {
            selectedByAttr = productSelect.find('option[selected]');
          }
          if (selectedByAttr.length) {
            var attrVal = selectedByAttr.attr('value') || selectedByAttr.val();
            if (attrVal && attrVal !== '0' && attrVal !== '') {
              variantId = attrVal;
              productSelect.val(variantId);
            }
          }
        }
      }
      
      // Check if this product has visible variant selectors that require user selection
      // Only validate if there are visible variant dropdowns/swatches that the user needs to interact with
      var hasVisibleVariantSelectors = $form.find('.single-option-selector:visible, .custom-variant-dropdown:visible, .variant-option-wrapper:visible, .carousel-variant-selector:visible').length > 0;
      var hasMultipleSelectableVariants = productSelect.length > 0 && productSelect.find('option[value!=""][value!="0"]:not(:disabled)').length > 1;
      
      // Only validate variant selection if the product has visible variant selectors that require user interaction
      // Products with no variants or single variant (where variant is auto-selected) don't need validation
      if (hasVisibleVariantSelectors && hasMultipleSelectableVariants) {
        // Check if variant ID is empty or invalid (0, empty string, etc.)
        if (!variantId || variantId === '0' || variantId === '') {
          // Remove any existing error messages
          $form.find('.variant-error-message').remove();
          
          // Show error message
          var errorMsg = $('<div class="variant-error-message" style="color: #d32f2f; padding: 10px; margin: 10px 0; background: #ffebee; border: 1px solid #ffcdd2; border-radius: 4px;">Please select a variant before adding to cart.</div>');
          var $submitButton = $form.find('.dT_AddToCart, button[type="submit"][name="add"]');
          if ($submitButton.length) {
            $submitButton.before(errorMsg);
          } else {
            $form.prepend(errorMsg);
          }
          
          // Scroll to error message
          $('html, body').animate({
            scrollTop: errorMsg.offset().top - 100
          }, 300);
          
          // Remove error after 5 seconds
          setTimeout(function() {
            errorMsg.fadeOut(function() {
              $(this).remove();
            });
          }, 5000);
          
          return false;
        }
      }
      
      // Ensure variant ID is set in the form before submission
      // This is important for single-variant products
      if (variantId && variantId !== '0' && variantId !== '') {
        // Set ProductSelect value if it exists
        if (productSelect.length) {
          productSelect.val(variantId);
          // Ensure ProductSelect has name="id" attribute
          if (!productSelect.attr('name')) {
            productSelect.attr('name', 'id');
          }
        }
        
        // Also ensure there's a hidden input with name="id" if it doesn't exist
        var idInput = $form.find('input[name="id"]');
        if (!idInput.length) {
          $form.append('<input type="hidden" name="id" value="' + variantId + '">');
        } else {
          idInput.val(variantId);
        }
      }

      // Final check - if still no variant ID, try one more time with a different approach
      if (!variantId || variantId === '0' || variantId === '') {
        // Try to find ProductSelect by checking all selects in the form
        var allSelects = $form.find('select');
        allSelects.each(function() {
          var $select = $(this);
          if ($select.attr('id') && $select.attr('id').indexOf('ProductSelect') !== -1) {
            productSelect = $select;
            var val = $select.val();
            if (val && val !== '0' && val !== '') {
              variantId = val;
              return false; // break loop
            }
            // Try to get first option
            var opt = $select.find('option[value]:not([value=""]):not([value="0"])').first();
            if (opt.length) {
              variantId = opt.attr('value') || opt.val();
              if (variantId && variantId !== '0' && variantId !== '') {
                $select.val(variantId);
                return false; // break loop
              }
            }
          }
        });
      }
      
      // If still no variant ID, show error with debug info
      if (!variantId || variantId === '0' || variantId === '') {
        console.log('Variant ID not found. Form:', $form[0], 'ProductSelect:', productSelect[0], 'Options:', productSelect.find('option').length);
        $form.find('.variant-error-message').remove();
        var errorMsg = $('<div class="variant-error-message" style="color: #d32f2f; padding: 10px; margin: 10px 0; background: #ffebee; border: 1px solid #ffcdd2; border-radius: 4px;">Unable to add product to cart. Please refresh the page and try again.</div>');
        var $submitButton = $form.find('.dT_AddToCart, button[type="submit"][name="add"]');
        if ($submitButton.length) {
          $submitButton.before(errorMsg);
        } else {
          $form.prepend(errorMsg);
        }
        return false;
      }

      // Ensure the variant ID is in the form data that will be serialized
      // Make sure ProductSelect has name="id" attribute
      if (productSelect.length && !productSelect.attr('name')) {
        productSelect.attr('name', 'id');
      }
      
      // Ensure ProductSelect value is set
      if (productSelect.length) {
        productSelect.val(variantId);
      }
      
      // Ensure hidden input with name="id" exists and has the correct value
      var idInput = $form.find('input[name="id"]');
      if (!idInput.length) {
        $form.append('<input type="hidden" name="id" value="' + variantId + '">');
      } else {
        idInput.val(variantId);
      }

      // Set updating flag to prevent duplicate submissions
      isUpdating = true;
      
      // Add class to be styled if desired
      var $submitButton = $form.find('.dT_AddToCart, button[type="submit"][name="add"], input[type="submit"][name="add"]');
      $submitButton.removeClass('is-added').addClass('is-adding');

      // Remove any previous quantity errors and variant errors
      $('.qty-error').remove();
      $form.find('.variant-error-message').remove();

      ShopifyAPI.addItemFromForm(evt.target, itemAddedCallback, itemErrorCallback);
    });
  };

  itemAddedCallback = function (product) {
    isUpdating = false;
    var $submitButton = $formContainer.find('.dT_AddToCart.is-adding, button[type="submit"][name="add"].is-adding, input[type="submit"][name="add"].is-adding');
    $submitButton.removeClass('is-adding').addClass('is-added');
    ShopifyAPI.getCart(cartUpdateCallback);
  };

  itemErrorCallback = function (XMLHttpRequest, textStatus) {
    isUpdating = false;
    var $submitButton = $formContainer.find('.dT_AddToCart.is-adding, button[type="submit"][name="add"].is-adding, input[type="submit"][name="add"].is-adding');
    $submitButton.removeClass('is-adding is-added');
    var data = eval('(' + XMLHttpRequest.responseText + ')');
    $addToCart.removeClass('is-adding is-added');

    if (!!data.message) {
      if (data.status == 422) {
        var $addButtoncontainer = $formContainer.find('.product-add');
        $addButtoncontainer.before('<div class="errors qty-error">'+ data.description +'</div>')
      }
    }
  };

  cartUpdateCallback = function (cart) {
    // Update quantity and price
    updateCountPrice(cart);
    buildCart(cart);
  };

  buildCart = function(cart) {
    // Start with a fresh cart div
    $cartContainer.empty();

    // Show empty cart
    if (cart.item_count === 0) {
      $cartContainer
        .append('<p class="cart-content"> Your cart is currently empty. <a class="dt-sc-btn" href="/collections/all">Continue Shopping</a></p>');
      cartCallback(cart);
      return;
    }

    // Handlebars.js cart layout
    var items = [],
      item = {},
      data = {},
      source = $('#CartTemplate').html(),
      template = Handlebars.compile(source);

    // Add each item to our handlebars.js data
    $.each(cart.items, function(index, cartItem) {
      /* Hack to get product image thumbnail
       *   - If image is not null
       *     - Remove file extension, add _small, and re-add extension
       *     - Create server relative link
       *   - A hard-coded url of no-image
      */
      var prodImg;
      if (cartItem.image !== null) {
        prodImg = cartItem.image
          .replace(/(\.[^.]*)$/, '_medium$1')
          .replace('http:', '');
      } else {
        prodImg =
          '//cdn.shopify.com/s/assets/admin/no-image-medium-cc9732cb976dd349a0df1d39816fbcc7.gif';
      }

      if (cartItem.properties !== null) {
        $.each(cartItem.properties, function(key, value) {
          if (key.charAt(0) === '_' || !value) {
            delete cartItem.properties[key];
          }
        });
      }

      if (cartItem.properties !== null) {
        $.each(cartItem.properties, function(key, value) {
          if (key.charAt(0) === '_' || !value) {
            delete cartItem.properties[key];
          }
        });
      }

      if (cartItem.line_level_discount_allocations.length !== 0) {
        for (var discount in cartItem.line_level_discount_allocations) {
          var amount =
            cartItem.line_level_discount_allocations[discount].amount;

          cartItem.line_level_discount_allocations[
            discount
          ].formattedAmount = Shopify.formatMoney(
            amount,
            settings.moneyFormat
          );
        }
      }

      if (cart.cart_level_discount_applications.length !== 0) {
        for (var cartDiscount in cart.cart_level_discount_applications) {
          var cartAmount =
            cart.cart_level_discount_applications[cartDiscount]
              .total_allocated_amount;

          cart.cart_level_discount_applications[
            cartDiscount
          ].formattedAmount = Shopify.formatMoney(
            cartAmount,
            settings.moneyFormat
          );
        }
      }

      // Create item's data object and add to 'items' array
      item = {
        key: cartItem.key,
        line: index + 1, // Shopify uses a 1+ index in the API
        url: cartItem.url,
        img: prodImg,
        name: cartItem.product_title,
        variation: cartItem.variant_title,
        properties: cartItem.properties,
        itemAdd: cartItem.quantity + 1,
        itemMinus: cartItem.quantity - 1,
        itemQty: cartItem.quantity,
        price: Shopify.formatMoney(
          cartItem.original_line_price,
          settings.moneyFormat
        ),
        discountedPrice: Shopify.formatMoney(
          cartItem.final_line_price,
          settings.moneyFormat
        ),
        discounts: cartItem.line_level_discount_allocations,
        discountsApplied:
          cartItem.line_level_discount_allocations.length === 0 ? false : true,
        vendor: cartItem.vendor
      };

      items.push(item);
    });

    // Gather all cart data and add to DOM
    data = {
      items: items,
      note: cart.note,
      subTotalPrice: Shopify.formatMoney(
        cart.items_subtotal_price,
        settings.moneyFormat
      ),
      totalPrice: Shopify.formatMoney(
        cart.total_price,
        settings.moneyFormat
      ),
      cartTotalDiscounts: Shopify.formatMoney(
        cart.total_discount,
        settings.moneyFormat
      ),
      cartDiscounts: cart.cart_level_discount_applications,
      cartDiscountsApplied:
        cart.cart_level_discount_applications.length === 0 ? false : true,
      cartTotalSavings: cart.cart_level_discount_applications.length === 0 && cart.total_discount > 0
    };

    $cartContainer.append(template(data));

    cartCallback(cart);
  };

  cartCallback = function(cart) {
    $body.removeClass('drawer--is-loading');
    $body.trigger('ajaxCart.afterCartLoad', cart);

     if (window.Shopify && Shopify.StorefrontExpressButtons) {
      Shopify.StorefrontExpressButtons.initialize();
    }

  };

  adjustCart = function () {
    // Delegate all events because elements reload with the cart

    // Add or remove from the quantity
    $body.on('click', '.ajaxcart__qty-adjust', function() {
      var $el = $(this),
          line = parseInt($el.data('line'), 10),
          variantId = $el.attr('data-id') || $el.data('id'),
          $qtySelector = $el.siblings('.ajaxcart__qty-num'),
          qty = parseInt($qtySelector.val().replace(/\D/g, ''));

      var qty = validateQty(qty);

      // Add or subtract from the current quantity
      if ($el.hasClass('ajaxcart__qty--plus')) {
        qty += 1;
      } else {
        qty -= 1;
        if (qty <= 0) qty = 0;
      }

      // If it has a data-line, update the cart.
      // Otherwise, just update the input's number
      if (line && !isNaN(line) && line > 0) {
        updateQuantity(line, qty, variantId);
      } else {
        $qtySelector.val(qty);
      }
    });
    
    
    // Remove item from cart (set quantity to 0)
    $body.on('click', '.ajaxcart__qty-remove', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      var $el = $(this),
          line = $el.attr('data-line') || $el.data('line'),
          variantId = $el.attr('data-id') || $el.data('id') || $el.attr('data-variant-id') || $el.data('variant-id');
      
      // Parse line as integer (1-based index)
      line = parseInt(line, 10);
      
      // Always set quantity to 0 to remove the item
      // Pass both line and variantId - updateQuantity will use line if valid, otherwise variantId
      updateQuantity(line, 0, variantId);
    });
    
    

    // Update quantity based on input on change
    $body.on('change', '.ajaxcart__qty-num', function() {
      var $el = $(this),
          line = parseInt($el.data('line'), 10),
          variantId = $el.attr('data-id') || $el.data('id'),
          qty = parseInt($el.val().replace(/\D/g, ''));

      var qty = validateQty(qty);

      // If it has a data-line, update the cart
      if (line && !isNaN(line) && line > 0) {
        updateQuantity(line, qty, variantId);
      }
    });

    // Prevent cart from being submitted while quantities are changing
    $body.on('submit', 'form.ajaxcart', function(evt) {
      if (isUpdating) {
        evt.preventDefault();
      }
    });

    // Highlight the text when focused
    $body.on('focus', '.ajaxcart__qty-adjust', function() {
      var $el = $(this);
      setTimeout(function() {
        $el.select();
      }, 50);
    });

    function updateQuantity(line, qty, variantId) {
      isUpdating = true;

      // Add activity classes when changing cart quantities
      var $row = $('.ajaxcart__row[data-line="' + line + '"]').addClass('is-loading');

      if (qty === 0) {
        $row.parent().addClass('is-removed');
      }

      // Slight delay to make sure removed animation is done
      setTimeout(function() {
        ShopifyAPI.changeItem(line, qty, adjustCartCallback, variantId);
      }, 250);
    }

    // Save note anytime it's changed
    $body.on('change', 'textarea[name="note"]', function() {
      var newNote = $(this).val();

      // Update the cart note in case they don't click update/checkout
      ShopifyAPI.updateCartNote(newNote, function(cart) {});
    });
  };

  adjustCartCallback = function (cart) {
    isUpdating = false;

    // Update quantity and price
    updateCountPrice(cart);

    // Reprint cart on short timeout so you don't see the content being removed
    setTimeout(function() {
      ShopifyAPI.getCart(buildCart);
    }, 150)
  };

  createQtySelectors = function() {
    // If there is a normal quantity number field in the ajax cart, replace it with our version
    if ($('input[type="number"]', $cartContainer).length) {
      $('input[type="number"]', $cartContainer).each(function() {
        var $el = $(this),
            currentQty = $el.val();

        var itemAdd = currentQty + 1,
            itemMinus = currentQty - 1,
            itemQty = currentQty;

        var source   = $("#AjaxQty").html(),
            template = Handlebars.compile(source),
            data = {
              id: $el.data('id'),
              itemQty: itemQty,
              itemAdd: itemAdd,
              itemMinus: itemMinus
            };

        // Append new quantity selector then remove original
        $el.after(template(data)).remove();
      });
    }
  };

  qtySelectors = function() {
    // Change number inputs to JS ones, similar to ajax cart but without API integration.
    // Make sure to add the existing name and id to the new input element
    var numInputs = $('input[type="number"]');

    if (numInputs.length) {
      numInputs.each(function() {
        var $el = $(this),
            currentQty = $el.val(),
            inputName = $el.attr('name'),
            inputId = $el.attr('id');

        var itemAdd = currentQty + 1,
            itemMinus = currentQty - 1,
            itemQty = currentQty;

        var source   = $("#JsQty").html(),
            template = Handlebars.compile(source),
            data = {
              id: $el.data('id'),
              itemQty: itemQty,
              itemAdd: itemAdd,
              itemMinus: itemMinus,
              inputName: inputName,
              inputId: inputId
            };

        // Append new quantity selector then remove original
        $el.after(template(data)).remove();
      });

      // Setup listeners to add/subtract from the input
      $('.js-qty__adjust').on('click', function() {
        var $el = $(this),
            id = $el.data('id'),
            $qtySelector = $el.siblings('.js-qty__num'),
            qty = parseInt($qtySelector.val().replace(/\D/g, ''));

        var qty = validateQty(qty);

        // Add or subtract from the current quantity
        if ($el.hasClass('js-qty__adjust--plus')) {
          qty += 1;
        } else {
          qty -= 1;
          if (qty <= 1) qty = 1;
        }
      });
    }
  };

  validateQty = function (qty) {
    if((parseFloat(qty) == parseInt(qty)) && !isNaN(qty)) {
      // We have a valid number!
    } else {
      // Not a number. Default to 1.
      qty = 1;
    }
    return qty;
  };

  module = {
    init: init,
    load: loadCart
  };



  return module;

}(ajaxCart || {}, jQuery));
